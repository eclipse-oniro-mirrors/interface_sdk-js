'use static'
/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License"),
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * @file
 * @kit ArkUI
 */

import { ToJSONType, FromJSONType } from './persistentStorage';
import contextConstant from '@ohos.app.ability.contextConstant';

/**
 * Function that returns default creator.
 *
 * @typedef { function } StorageDefaultCreator<T>
 * @returns { T } default creator
 * @syscap SystemCapability.ArkUI.ArkUI.Full
 * @since 20 static
 */
export declare type StorageDefaultCreator<T> = () => T;

/**
 * Define ConnectOptions class.
 * @typedef ConnectOptions
 * @syscap SystemCapability.ArkUI.ArkUI.Full
 * @since 20 static
 */
export declare interface ConnectOptions<T extends object> {

  /**
   * Define class constructor
   * @type { Type } type class type of the stored value.
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  type: Type;

  /**
   * Defines alias name of the key, or the function generating the default value.
   * @type { ?string }
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  key?: string;

  /**
   * Define the function generating the default value.
   * @type { ?StorageDefaultCreator<T>}
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  defaultCreator?: StorageDefaultCreator<T>;

  /**
   * Define encrypted partition for data storage.
   * if not passed in, the defaule value is El2
   *
   * @type { ?contextConstant.AreaMode}
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  areaMode?: contextConstant.AreaMode;
}

/**
 * Function that returns reason type when error.
 *
 * @typedef { function } PersistenceErrorCallback
 * @param { string } key persisted key when error
 * @param { 'quota' | 'serialization' | 'unknown' } reason reason type when error
 * @param { string } message more message when error
 * @syscap SystemCapability.ArkUI.ArkUI.Full
 * @since 20 static
 */
export declare type PersistenceErrorCallback = (key: string, reason: 'quota' | 'serialization' | 'unknown', message: string) => void;

/**
 * Defines Serializable object
 *
 * @extends jsonx.JsonElementSerializable, jsonx.JsonElementDeserializable
 * @interface SerializableObject
 * @syscap SystemCapability.ArkUI.ArkUI.Full
 * @since 20 static
 */
export interface SerializableObject extends jsonx.JsonElementSerializable, jsonx.JsonElementDeserializable {}

/**
 * PersistenceV2 is for UI state of app-wide access, available on app re-start,
 * and saves database content in disk.
 *
 * @syscap SystemCapability.ArkUI.ArkUI.Full
 * @since 20 static
 */
export declare class PersistenceV2 {
  /**
   * If used by persistenceV2, module-level storage path, different modules will have their own storage paths.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { Type } ttype class type of the stored value.
   * @param { ToJSONType<T> } toJson to Json function.
   * @param { FromJSONType<T> } fromJson serializable function.
   * @param { StorageDefaultCreator<T> } [defaultCreator] the function generating the default value
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static connect<T extends object>(
    ttype: Type,
    toJson: ToJSONType<T>, 
    fromJson: FromJSONType<T>,
    defaultCreator?: StorageDefaultCreator<T>
  ): T | undefined;

  /**
   * If used by persistenceV2, module-level storage path, different modules will have their own storage paths.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { Type } ttype class type of the stored value.
   * @param { string } key - alias name of the key.
   * @param { ToJSONType<T> } toJson to Json function.
   * @param { FromJSONType<T> } fromJson serializable function.
   * @param { StorageDefaultCreator<T> } [defaultCreator] the function generating the default value
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static connect<T extends object>(
    ttype: Type,
    key: string,
    toJson: ToJSONType<T>, 
    fromJson: FromJSONType<T>,
    defaultCreator?: StorageDefaultCreator<T>
  ): T | undefined;

  /**
   * If used by persistenceV2, module-level storage path, different modules will have their own storage paths.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { Type } ttype class type of the stored value.
   * @param { StorageDefaultCreator<T> } [defaultCreator] the function generating the default value.
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static connect<T extends SerializableObject>(
    ttype: Type,
    defaultCreator?: StorageDefaultCreator<T>
  ): T | undefined;

  /**
   * If used by persistenceV2, module-level storage path, different modules will have their own storage paths.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { Type } ttype class type of the stored value.
   * @param { string } key - alias name of the key.
   * @param { StorageDefaultCreator<T> } [defaultCreator] the function generating the default value
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static connect<T extends SerializableObject>(
    ttype: Type,
    key: string,
    defaultCreator?: StorageDefaultCreator<T>
  ): T | undefined;

  /**
   * Application-level storage path, sharing a storage path for all modules under the application.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { ConnectOptions<T> } connectOptions Application level storage parameters.
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static globalConnect<T extends SerializableObject>(connectOptions: ConnectOptions<T>): T | undefined;

  /**
   * Application-level storage path, sharing a storage path for all modules under the application.
   * If the value for the given key is already available, return the value.
   * If not, add the key with value generated by calling defaultFunc and return it to caller.
   *
   * @param { ConnectOptions<T> } connectOptions Application level storage parameters.
   * @param { ToJSONType<T> } toJson to Json function.
   * @param { FromJSONType<T> } fromJson serializable function.
   * @returns { T | undefined } the value of the existed key or the default value
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static globalConnect<T extends object>(connectOptions: ConnectOptions<T>,
    toJson: ToJSONType<T>, fromJson: FromJSONType<T>): T | undefined;

  /**
   * Used to manually persist data changes to disks.
   *
   * @param { string | Type } keyOrType key or class type need to persist.
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static save(keyOrType: string | Type): void;

  /**
   * Be called when persisting has encountered an error.
   *
   * @param { PersistenceErrorCallback | undefined } callback called when error
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static notifyOnError(callback: PersistenceErrorCallback | undefined): void;

  /**
   * Removes data with the given key or given class type.
   *
   * @param { string | Type } keyOrType key or class type removing
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static remove(keyOrType: string | Type): void;

  /**
   * Return the array of all keys.
   *
   * @returns { Array<string> } the array of all keys
   * @static
   * @syscap SystemCapability.ArkUI.ArkUI.Full
   * @since 20 static
   */
  static keys(): Array<string>;
}